% Copyright (c) 2025 Alexander Bluhm <bluhm@genua.de>
%
% Permission to use, copy, modify, and distribute this software for any
% purpose with or without fee is hereby granted, provided that the above
% copyright notice and this permission notice appear in all copies.
%
% THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
% WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
% MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
% ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
% WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
% ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
% OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

\documentclass[14pt,aspectratio=169]{beamer}
\usetheme{Frankfurt}
\usepackage{tikz}
\usepackage{framed}
\usepackage{adjustbox}
\usepackage{graphicx}
\usepackage{varwidth}
\usepackage{tipa}
\usepackage{alltt}
\usepackage{xcolor}
\usepackage{upquote}
\usepackage[T1]{fontenc}
\usepackage{textcomp}
\usetikzlibrary{shapes.arrows}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{shapes.multipart}
\usetikzlibrary{shapes.symbols}

\author{Alexander Bluhm}
\title{Running Network Protocols in Parallel}
\institute{bluhm@openbsd.org}
\date{EuroBSDCon, September 2025}

\begin{document}

\begin{frame}
\titlepage
\end{frame}

\begin{frame}{Agenda}
\setcounter{tocdepth}{1}
\tableofcontents
\end{frame}

\section{History}

\subsection{Single Processor SPL}
\begin{frame}{Single Processor SPL, 1980s}
\begin{tikzpicture}
    \path (0, 0) node [draw] (ul) {User Land};
    \path (0, -2) node [draw] (to) {Kernel Top Half};
    \draw [->] (ul) -- (to) node[midway,right] {System Call};
    \path (0, -4) node [draw] (bo) {Kernel Bottom Half};
    \draw [<-] (to.south) -- (bo.north) node[midway,right] {Interrupt};
    \path (to.south) node (tos) {} (bo.north) node (bon) {};
    \draw [->,red] (tos.west) -- (bon.west) node[midway,left,red] {SPL};
    \path (0, -6) node [draw] (hw) {Hardware};
    \draw [<-] (bo) -- (hw) node[midway,right] {Handler};
    \path (bo.south) node (bos) {} (hw.north) node (hwn) {};
    \draw [->,red,dashed] (bos.west) -- (hwn.west) node[midway,left,red] {SPL};
\end{tikzpicture}
\end{frame}

\subsection{Softnet AST}
\begin{frame}{Softnet AST, 1990s}
\begin{tikzpicture}
    \path (0, 0) node [draw] (ul) {User Land};
    \path (0, -1.5) node [draw] (to) {Kernel Top Half};
    \draw [->] (ul) -- (to) node[midway,right] {System Call};
    \path (0, -3) node [draw] (ns) {Network Stack};
    \draw [<-] (to.south) -- (ns.north) node[midway,right] {Software Interrupt};
    \path (to.south) node (tos) {} (ns.north) node (nsn) {};
    \draw [->,red] (tos.west) -- (nsn.west) node[midway,left,red] {SPL Softnet};
    \path (0, -4.5) node [draw] (di) {Driver Interrupt};
    \draw [<-] (ns.south) -- (di.north) node[midway,right] {Hardware Interrupt};
    \path (ns.south) node (nss) {} (di.north) node (din) {};
    \draw [->,red] (nss.west) -- (din.west) node[midway,left,red] {SPL Net};
    \path (0, -6) node [draw] (hw) {Hardware};
    \draw [<-] (di) -- (hw) node[midway,right] {Interrupt Vector};
    \path (di.south) node (dis) {} (hw.north) node (hwn) {};
    \draw [->,red,dashed] (dis.west) -- (hwn.west) node[midway,left,red] {SPL};
\end{tikzpicture}
\end{frame}

\subsection{Multi Processor Kernel Lock}
\begin{frame}{Multi Processor Kernel Lock, 2000s}
\begin{tikzpicture}
    \path (0, 0) node [draw] (ul) {User Land};
    \path (0, -2) node [draw] (to) {Kernel Top Half};
    \draw [->] (ul) -- (to) node[midway,right] {System Call};
    \path (0, -4) node [draw] (bo) {Kernel Bottom Half};
    \draw [<-] (to.south) -- (bo.north) node[midway,right] {Interrupt};
    \path (to.south) node (tos) {} (bo.north) node (bon) {};
    \draw [->,red] (tos.west) -- (bon.west) node[midway,left,red] {SPL};
    \path (0, -6) node [draw] (hw) {Hardware};
    \draw [<-] (bo) -- (hw) node[midway,right] {Handler};
    \path (bo.south) node (bos) {} (hw.north) node (hwn) {};
    \draw [->,red,dashed] (bos.west) -- (hwn.west) node[midway,left,red] {SPL};

    \path (7.5, 0) node [draw] (ul1) {User Land};
    \path (7.5, -2) node [draw] (to1) {Kernel Top Half};
    \draw [->] (ul1) -- (to1) node[midway,right] {System Call};

    \draw [<->,red] (to) -- (to1) node[midway,above] {Kernel Lock};
    \draw [<->,red] (bo.north east) -- (to1.south west)
        node[midway,below right] {Kernel Lock};
\end{tikzpicture}
\end{frame}

\subsection{Kernel Lock and Network Lock}
\begin{frame}{Kernel Lock and Net Lock, 2015}
\begin{tikzpicture}
    \path (0, 0) node [draw] (ul) {User Land};
    \path (0, -2) node [draw] (to) {Kernel Top Half};
    \draw [->] (ul) -- (to) node[midway,right] {System Call};
    \path (0, -4) node [draw] (bo) {Kernel Bottom Half};
    \draw [<-] (to.south) -- (bo.north) node[midway,right] {Interrupt};
    \path (to.south) node (tos) {} (bo.north) node (bon) {};
    \draw [->,red] (tos.west) -- (bon.west) node[midway,left,red] {SPL};
    \path (0, -6) node [draw] (hw) {Hardware};
    \draw [<-] (bo) -- (hw) node[midway,right] {Handler};
    \path (bo.south) node (bos) {} (hw.north) node (hwn) {};
    \draw [->,red,dashed] (bos.west) -- (hwn.west) node[midway,left,red]
	{SPL};

    \path (7.5, 0) node [draw] (ul1) {User Land};
    \path (7.5, -1.5) node [draw] (to1) {Kernel Top Half};
    \draw [->] (ul1) -- (to1) node[midway,right] {System Call};
    \path (7.5, -3) node [draw] (ns1) {Network Stack};
    \draw [<->] (to1.south) -- (ns1.north) node[midway,right] {Kernel Thread};
    \path (to1.south) node (tos1) {} (ns1.north) node (nsn1) {};
    \draw [<->,red] (tos1.west) -- (nsn1.west) node[midway,left,red] {Net Lock};
    \path (7.5, -4.5) node [draw] (di1) {Driver Interrupt};
    \draw [<-] (ns1.south) -- (di1.north) node[midway,right]
	{Hardware Interrupt};
    \path (ns1.south) node (nss1) {} (di1.north) node (din1) {};
    \draw [->,red] (nss1.west) -- (din1.west) node[midway,left,red] {SPL Net};
    \path (7.5, -6) node [draw] (hw1) {Hardware};
    \draw [<-] (di1) -- (hw1) node[midway,right] {Vector};
    \path (di1.south) node (dis1) {} (hw1.north) node (hwn1) {};
    \draw [->,red,dashed] (dis1.west) -- (hwn1.west) node[midway,left,red]
	{SPL};

    \draw [<->,red] (to) -- (to1) node[midway,above] {Kernel Lock};
    \draw [<->,red] (bo.north east) -- (to1.south west);
    \draw [<->,red] (to.south east) -- (di1.north west);
    \draw [<->,red] (bo) -- (di1) node[midway,below] {Kernel Lock};
\end{tikzpicture}
\end{frame}

\subsection{Unlock Network System Calls}
\begin{frame}{Unlock Network System Calls, 2018}
\begin{tikzpicture}
    \path (0, 0) node [draw] (ul) {User Land};
    \path (0, -2) node [draw] (to) {Kernel Top Half};
    \draw [->] (ul) -- (to) node[midway] {System Call};
    \path (0, -4) node [draw] (bo) {Bottom Half};
    \draw [<-] (to.south) -- (bo.north) node[midway,right] {Interrupt};
    \path (to.south) node (tos) {} (bo.north) node (bon) {};
    \draw [->,red] (tos.west) -- (bon.west) node[midway,left,red] {SPL};
    \path (0, -6) node [draw] (hw) {Hardware};
    \draw [<-] (bo) -- (hw) node[midway,right] {Handler};
    \path (bo.south) node (bos) {} (hw.north) node (hwn) {};
    \draw [->,red,dashed] (bos.west) -- (hwn.west) node[midway,left,red]
	{SPL};

    \path (4, 0) node [draw] (ul1) {User Land};
    \path (4, -1.5) node [draw] (to1) {Kernel Top Half};
    \draw [->] (ul1) -- (to1) node[midway] {Network Call};
    \path (4, -3) node [draw] (ns1) {Network Stack};
    \draw [<->] (to1.south) -- (ns1.north) node[midway,right] {};
    \path (to1.south) node (tos1) {} (ns1.north) node (nsn1) {};
    \draw [<->,red] (tos1.west) -- (nsn1.west) node[midway,right,red]
	{Net Lock};
    \path (4, -4.5) node [draw] (di1) {Driver Interrupt};
    \draw [<-] (ns1.south) -- (di1.north) node[midway,right]
	{Hardware Interrupt};
    \path (ns1.south) node (nss1) {} (di1.north) node (din1) {};
    \draw [->,red] (nss1.west) -- (din1.west) node[midway,left,red] {SPL Net};
    \path (4, -6) node [draw] (hw1) {Hardware};
    \draw [<-] (di1) -- (hw1) node[midway,right] {Vector};
    \path (di1.south) node (dis1) {} (hw1.north) node (hwn1) {};
    \draw [->,red,dashed] (dis1.west) -- (hwn1.west) node[midway,left,red]
	{SPL};

    \path (10, 0) node [draw] (ul2) {User Land};
    \path (10, -1.5) node [draw] (to2) {Kernel Top Half};
    \draw [->] (ul2) -- (to2) node[midway] {Network Call};
    \path (10, -3) node [draw] (ns2) {Network Stack};
    \draw [->] (to2.south) -- (ns2.north) node[midway,right] {};
    \path (to2.south) node (tos2) {} (ns2.north) node (nsn2) {};
    \draw [<->,red] (tos2.west) -- (nsn2.west) node[midway,left,red] {Net Lock};

    \draw [<->,red] (to1) -- (to2) node[midway,above] {Net Lock};
    \draw [<->,red] (ns1.north east) -- (to2.south west);
    \draw [<->,red] (to1.south east) -- (ns2.north west);
    \draw [<->,red] (ns1) -- (ns2) node[midway,below] {Net Lock};
\end{tikzpicture}
\end{frame}

\subsection{Multi Queue Drivers}
\begin{frame}{Multi Queue Drivers, 2020}
\begin{tikzpicture}
    \path (0, 0) node [draw] (ul) {User Land};
    \path (0, -1.5) node [draw] (to) {Kernel Top Half};
    \draw [->] (ul) -- (to) node[midway,right] {System Call};
    \path (0, -3) node [draw] (ns) {Network Stack};
    \draw [->] (to.south) -- (ns.north) node[midway,right] {};
    \path (to.south) node (tos) {} (ns.north) node (nsn) {};
    \draw [<->,red] (tos.west) -- (nsn.west) node[midway,right,red] {Net Lock};
    \path (0, -4.5) node [draw] (di) {Driver Interrupt};
    \draw [<-] (ns.south) -- (di.north) node[midway,right]
	{Hardware Interrupt};
    \path (ns.south) node (nss) {} (di.north) node (din) {};
    \draw [<->,red] (nss.west) -- (din.west) node[midway,left,red] {Mutex};
    \path (0, -6) node (hw) {Queue};
    \draw [<-] (di) -- (hw) node[midway,right] {Per CPU Vector};
    \path (di.south) node (dis) {} (hw.north) node (hwn) {};
    \draw [->,red] (dis.west) -- (hwn.west) node[midway,left,red] {MSIX};

    \path (7.5, 0) node [draw] (ul1) {User Land};
    \path (7.5, -1.5) node [draw] (to1) {Kernel Top Half};
    \draw [->] (ul1) -- (to1) node[midway,right] {System Call};
    \path (7.5, -3) node [draw] (ns1) {Network Stack};
    \draw [<->] (to1.south) -- (ns1.north) node[midway,right] {Kernel Thread};
    \path (to1.south) node (tos1) {} (ns1.north) node (nsn1) {};
    \draw [<->,red] (tos1.west) -- (nsn1.west) node[midway,left,red] {Net Lock};
    \path (7.5, -4.5) node [draw] (di1) {Driver Interrupt};
    \draw [<-] (ns1.south) -- (di1.north) node[midway,right]
	{Hardware Interrupt};
    \path (ns1.south) node (nss1) {} (di1.north) node (din1) {};
    \draw [<->,red] (nss1.west) -- (din1.west) node[midway,left,red] {Mutex};
    \path (7.5, -6) node (hw1) {Queue};
    \draw [<-] (di1) -- (hw1) node[midway,right] {Per CPU Vector};
    \path (di1.south) node (dis1) {} (hw1.north) node (hwn1) {};
    \draw [->,red] (dis1.west) -- (hwn1.west) node[midway,left,red] {MSIX};

    \draw [<->,red] (to) -- (to1) node[midway,below] {Net Lock};
    \draw [<->,red] (ns.north east) -- (to1.south west) node[midway] {};
    \draw [<->,red] (to.south east) -- (ns1.north west) node[midway] {};
    \draw [<->,red] (ns) -- (ns1) node[midway,above] {Net Lock};
    \draw [-] (hw.north west) -- (hw1.north east) -- (hw1.south east) --
	(hw.south west) -- (hw.north west);
    \path (hw) -- (hw1) node[midway] {Hardware};
\end{tikzpicture}
\end{frame}

\subsection{Unlock Socket Receive Send}
\begin{frame}{Unlock Socket Receive and Send, 2022 and 2024}
\begin{tikzpicture}
    \path (0, 0) node [draw] (ul) {User Land};
    \path (0, -1.5) node [draw] (to) {Kernel Top Half};
    \draw [->] (ul) -- (to) node[midway,right] {System Call};
    \path (0, -3) node [draw] (ns) {Network Stack};
    \draw [->] (to.south) -- (ns.north) node[midway,right] {};
    \path (to.south) node (tos) {} (ns.north) node (nsn) {};
    \draw [<->,red] (tos.west) -- (nsn.west) node[midway,right,red] {Net Lock};
    \path (0, -4.5) node [draw] (di) {Driver Interrupt};
    \draw [<-] (ns.south) -- (di.north) node[midway,right]
	{Hardware Interrupt};
    \path (ns.south) node (nss) {} (di.north) node (din) {};
    \draw [<->,red] (nss.west) -- (din.west) node[midway,left,red] {Mutex};
    \path (0, -6) node (hw) {Queue};
    \draw [<-] (di) -- (hw) node[midway,right] {Per CPU Vector};
    \path (di.south) node (dis) {} (hw.north) node (hwn) {};
    \draw [->,red] (dis.west) -- (hwn.west) node[midway,left,red] {MSIX};

    \path (7.5, 0) node [draw] (ul1) {User Land};
    \path (7.5, -1.5) node [draw] (to1) {Kernel Top Half};
    \draw [->] (ul1) -- (to1) node[midway,right] {System Call};
    \path (7.5, -3) node [draw] (ns1) {Network Stack};
    \draw [<->] (to1.south) -- (ns1.north) node[midway,right] {Kernel Thread};
    \path (to1.south) node (tos1) {} (ns1.north) node (nsn1) {};
    \draw [<->,red] (tos1.west) -- (nsn1.west) node[midway,left,red] {Net Lock};
    \path (7.5, -4.5) node [draw] (di1) {Driver Interrupt};
    \draw [<-] (ns1.south) -- (di1.north) node[midway,right]
	{Hardware Interrupt};
    \path (ns1.south) node (nss1) {} (di1.north) node (din1) {};
    \draw [<->,red] (nss1.west) -- (din1.west) node[midway,left,red] {Mutex};
    \path (7.5, -6) node (hw1) {Queue};
    \draw [<-] (di1) -- (hw1) node[midway,right] {Per CPU Vector};
    \path (di1.south) node (dis1) {} (hw1.north) node (hwn1) {};
    \draw [->,red] (dis1.west) -- (hwn1.west) node[midway,left,red] {MSIX};

    \draw [<->,red] (ns.north east) -- (to1.south west) node[midway] {};
    \draw [<->,red] (to.south east) -- (ns1.north west) node[midway] {};
    \draw [<->,red] (ns) -- (ns1) node[midway,above] {Net Lock};
    \draw [-] (hw.north west) -- (hw1.north east) -- (hw1.south east) --
	(hw.south west) -- (hw.north west);
    \path (hw) -- (hw1) node[midway] {Hardware};
\end{tikzpicture}
\end{frame}



\section{Packet Processing}

\subsection{Network Protocol Stack}
\begin{frame}{Network Protocol Stack}
\begin{tikzpicture}
  \draw (0,0)
    node (idd) [right] {device driver} ++(.1,.6)
    rectangle ++(.4,.4) rectangle ++(.4,-.4)
    rectangle ++(.4,.4) rectangle ++(.4,-.4) ++(0,.2)
    node (iq) [right] {input queue} ++(-.5,.8)
    node (ii) [right] {ip\_input()} ++(0,1.0)
    node (ti) [right] {tcp\_input()} ++(.1,.8)
    node (rb) [left] {receive buffer} ++(0,-.2)
    rectangle ++(.4,.4) rectangle ++(.4,-.4)
    rectangle ++(.4,.4) rectangle ++(.4,-.4) ++(-.5,1.0)
    node (iso) [right] {socket} ++(3.2,0)

    node (oso) [right] {socket} ++(.1,-.6)
    rectangle ++(.4,-.4) rectangle ++(.4,.4)
    rectangle ++(.4,-.4) rectangle ++(.4,.4) ++(0,-.2)
    node (sb) [right] {send buffer} ++(-.5,-.8)
    node (to) [right] {tcp\_output()} ++(0,-1.0)
    node (io) [right] {ip\_output()} ++(0,-.6)
    rectangle ++(.4,-.4) rectangle ++(.4,.4)
    rectangle ++(.4,-.4) rectangle ++(.4,.4) ++(0,-.2)
    node (oq) [right] {output queue} ++(-.5,-.8)
    node (odd) [right] {device driver}
    ;
  \path (node cs:name=idd,anchor=west) +(.3+1*.4,.3) coordinate (iddo) {};
  \path (node cs:name=iq,anchor=west) +(-.2-2*.4,0) coordinate (iqi) {};
  \draw[->] (iddo) -- (iqi);
  \path (node cs:name=iq,anchor=west) +(-.2,0) coordinate (iqo) {};
  \path (node cs:name=ii,anchor=west) +(.3,-.3) coordinate (iii) {};
  \draw[->] (iqo) -- (iii);
  \path (node cs:name=ii,anchor=west) +(.3,.3) coordinate (iio) {};
  \path (node cs:name=ti,anchor=west) +(.3,-.3) coordinate (tii) {};
  \draw[->] (iio) -- (tii);
  \path (node cs:name=ti,anchor=west) +(.3+1*.4,.3) coordinate (iti) {};
  \path (node cs:name=rb,anchor=east) +(.2+1*.4,0) coordinate (rbi) {};
  \draw[->] (iti) -- (rbi);
  \path (node cs:name=rb,anchor=east) +(.2+3*.4,0) coordinate (rbo) {};
  \path (node cs:name=iso,anchor=west) +(.3,-.3) coordinate (isoi) {};
  \draw[->] (rbo) -- (isoi);

  \path (node cs:name=oso,anchor=west) +(.3+1*.4,-.3) coordinate (osoo) {};
  \path (node cs:name=sb,anchor=west) +(-.2-2*.4,0) coordinate (sbi) {};
  \draw[->] (osoo) -- (sbi);
  \path (node cs:name=sb,anchor=west) +(-.2,0) coordinate (sbo) {};
  \path (node cs:name=to,anchor=west) +(.3,.3) coordinate (toi) {};
  \draw[->] (sbo) -- (toi);
  \path (node cs:name=to,anchor=west) +(.3,-.3) coordinate (too) {};
  \path (node cs:name=io,anchor=west) +(.3,.3) coordinate (ioi) {};
  \draw[->] (too) -- (ioi);
  \path (node cs:name=io,anchor=west) +(.6,-.3) coordinate (ioo) {};
  \path (node cs:name=oq,anchor=west) +(-.2-2*.4,0) coordinate (oqi) {};
  \draw[->] (ioo) -- (oqi);
  \path (node cs:name=oq,anchor=west) +(-.2,0) coordinate (oqo) {};
  \path (node cs:name=odd,anchor=west) +(.3,.3) coordinate (oddi) {};
  \draw[->] (oqo) -- (oddi);

  \path (node cs:name=ii,anchor=east) +(.1,0) coordinate (ifo) {};
  \path (node cs:name=io,anchor=west) +(-.1,0) coordinate (ifi) {};
  \draw[->] (ifo) -- (ifi) node [midway,above] {ip\_forward()};
\end{tikzpicture}
\end{frame}

\subsection{Towards Parallel Processing}
\begin{frame}{Towards Parallel Processing}
\begin{tikzpicture}
  \draw (0,0)
    node (idd) [right] {device driver} ++(.1,.6)
    rectangle ++(.4,.4) rectangle ++(.4,-.4)
    rectangle ++(.4,.4) rectangle ++(.4,-.4) ++(0,.2)
    node (iq) [right] {input queue} ++(-.5,.8)
    node (ii) [right] {ip\_input()} ++(.1,.8)
    node (pq) [left] {protocol queue} ++(0,-.2)
    rectangle ++(.4,.4) rectangle ++(.4,-.4)
    rectangle ++(.4,.4) rectangle ++(.4,-.4) ++(-.5,1.0)
    node (ti) [right] {tcp\_input()} ++(.1,.8)
    node (rb) [left] {receive buffer} ++(0,-.2)
    rectangle ++(.4,.4) rectangle ++(.4,-.4)
    rectangle ++(.4,.4) rectangle ++(.4,-.4) ++(-.5,1.0)
    node (iso) [right] {socket} ++(3.2,0)

    node (oso) [right] {socket} ++(.1,-.6)
    rectangle ++(.4,-.4) rectangle ++(.4,.4)
    rectangle ++(.4,-.4) rectangle ++(.4,.4) ++(0,-.2)
    node (sb) [right] {send buffer} ++(-.5,-1.4)
    node (to) [right] {tcp\_output()} ++(0,-1.0)
    node (io) [right] {ip\_output()} ++(0,-.6)
    rectangle ++(.4,-.4) rectangle ++(.4,.4)
    rectangle ++(.4,-.4) rectangle ++(.4,.4) ++(0,-.2)
    node (oq) [right] {output queue} ++(-.5,-.8)
    node (odd) [right] {device driver}
    ;
  \path (node cs:name=idd,anchor=west) +(.3+1*.4,.3) coordinate (iddo) {};
  \path (node cs:name=iq,anchor=west) +(-.2-2*.4,0) coordinate (iqi) {};
  \draw[->,double] (iddo) -- (iqi);
  \path (node cs:name=iq,anchor=west) +(-.2,0) coordinate (iqo) {};
  \path (node cs:name=ii,anchor=west) +(.3,-.3) coordinate (iii) {};
  \draw[->,double] (iqo) -- (iii);
  \path (node cs:name=ii,anchor=west) +(.3+1*.4,.3) coordinate (iio) {};
  \path (node cs:name=pq,anchor=east) +(.2+1*.4,0) coordinate (pqi) {};
  \draw[->,double] (iio) -- (pqi);
  \path (node cs:name=pq,anchor=east) +(.2+3*.4,0) coordinate (pqo) {};
  \path (node cs:name=ti,anchor=west) +(.3,-.3) coordinate (tii) {};
  \draw[->] (pqo) -- (tii);
  \path (node cs:name=ti,anchor=west) +(.3+1*.4,.3) coordinate (iti) {};
  \path (node cs:name=rb,anchor=east) +(.2+1*.4,0) coordinate (rbi) {};
  \draw[->] (iti) -- (rbi);
  \path (node cs:name=rb,anchor=east) +(.2+3*.4,0) coordinate (rbo) {};
  \path (node cs:name=iso,anchor=west) +(.3,-.3) coordinate (isoi) {};
  \draw[->,double] (rbo) -- (isoi);

  \path (node cs:name=oso,anchor=west) +(.3+1*.4,-.3) coordinate (osoo) {};
  \path (node cs:name=sb,anchor=west) +(-.2-2*.4,0) coordinate (sbi) {};
  \draw[->,double] (osoo) -- (sbi);
  \path (node cs:name=sb,anchor=west) +(-.2,0) coordinate (sbo) {};
  \path (node cs:name=to,anchor=west) +(.3,.3) coordinate (toi) {};
  \draw[->,double] (sbo) -- (toi);
  \path (node cs:name=to,anchor=west) +(.3,-.3) coordinate (too) {};
  \path (node cs:name=io,anchor=west) +(.3,.3) coordinate (ioi) {};
  \draw[->,double] (too) -- (ioi);
  \path (node cs:name=io,anchor=west) +(.6,-.3) coordinate (ioo) {};
  \path (node cs:name=oq,anchor=west) +(-.2-2*.4,0) coordinate (oqi) {};
  \draw[->,double] (ioo) -- (oqi);
  \path (node cs:name=oq,anchor=west) +(-.2,0) coordinate (oqo) {};
  \path (node cs:name=odd,anchor=west) +(.3,.3) coordinate (oddi) {};
  \draw[->,double] (oqo) -- (oddi);

  \path (node cs:name=ii,anchor=east) +(.1,0) coordinate (ifo) {};
  \path (node cs:name=io,anchor=west) +(-.1,0) coordinate (ifi) {};
  \draw[->,double] (ifo) -- (ifi) node [midway,above] {ip\_forward()};

  \draw[red] (node cs:name=iso,anchor=west) +(0,-.1)
    node [left] {receive buffer mutex};
  \draw[red] (node cs:name=oso,anchor=east) +(0,-.1)
    node [right] {send buffer mutex};
  \draw[red] (node cs:name=ti,anchor=west) node [left] {exclusive net lock};
  \path (sbo) -- (toi) node [red,midway,right] {socket lock};
  \draw[red] (node cs:name=ii,anchor=west) node [left] {shared net lock};
  \path (ifo) -- (ifi) node [red,midway,below] {route srp};
  \path (idd) -- (odd) node [red,midway] {multi queue};
\end{tikzpicture}
\end{frame}

\subsection{Parallel TCP Input}
\begin{frame}{Parallel TCP Input}
\begin{tikzpicture}
  \draw (0,0)
    node (idd) [right] {device driver} ++(.1,.6)
    rectangle ++(.4,.4) rectangle ++(.4,-.4)
    rectangle ++(.4,.4) rectangle ++(.4,-.4) ++(0,.2)
    node (iq) [right] {input queue} ++(-.5,.8)
    node (ii) [right] {ip\_input()} ++(0,1.0)
    node (ti) [right] {tcp\_input()} ++(.1,.8)
    node (rb) [left] {receive buffer} ++(0,-.2)
    rectangle ++(.4,.4) rectangle ++(.4,-.4)
    rectangle ++(.4,.4) rectangle ++(.4,-.4) ++(-.5,1.0)
    node (iso) [right] {socket} ++(2.5,0)

    node (oso) [right] {socket} ++(.1,-.6)
    rectangle ++(.4,-.4) rectangle ++(.4,.4)
    rectangle ++(.4,-.4) rectangle ++(.4,.4) ++(0,-.2)
    node (sb) [right] {send buffer} ++(-.5,-.8)
    node (to) [right] {tcp\_output()} ++(0,-1.0)
    node (io) [right] {ip\_output()} ++(0,-.6)
    rectangle ++(.4,-.4) rectangle ++(.4,.4)
    rectangle ++(.4,-.4) rectangle ++(.4,.4) ++(0,-.2)
    node (oq) [right] {output queue} ++(-.5,-.8)
    node (odd) [right] {device driver}
    ;
  \path (node cs:name=idd,anchor=west) +(.3+1*.4,.3) coordinate (iddo) {};
  \path (node cs:name=iq,anchor=west) +(-.2-2*.4,0) coordinate (iqi) {};
  \draw[->,double] (iddo) -- (iqi);
  \path (node cs:name=iq,anchor=west) +(-.2,0) coordinate (iqo) {};
  \path (node cs:name=ii,anchor=west) +(.3,-.3) coordinate (iii) {};
  \draw[->,double] (iqo) -- (iii);
  \path (node cs:name=ii,anchor=west) +(.3,.3) coordinate (iio) {};
  \path (node cs:name=ti,anchor=west) +(.3,-.3) coordinate (tii) {};
  \draw[->,double] (iio) -- (tii);
  \path (node cs:name=ti,anchor=west) +(.3+1*.4,.3) coordinate (iti) {};
  \path (node cs:name=rb,anchor=east) +(.2+1*.4,0) coordinate (rbi) {};
  \draw[->,double] (iti) -- (rbi);
  \path (node cs:name=rb,anchor=east) +(.2+3*.4,0) coordinate (rbo) {};
  \path (node cs:name=iso,anchor=west) +(.3,-.3) coordinate (isoi) {};
  \draw[->,double] (rbo) -- (isoi);

  \path (node cs:name=oso,anchor=west) +(.3+1*.4,-.3) coordinate (osoo) {};
  \path (node cs:name=sb,anchor=west) +(-.2-2*.4,0) coordinate (sbi) {};
  \draw[->,double] (osoo) -- (sbi);
  \path (node cs:name=sb,anchor=west) +(-.2,0) coordinate (sbo) {};
  \path (node cs:name=to,anchor=west) +(.3,.3) coordinate (toi) {};
  \draw[->,double] (sbo) -- (toi);
  \path (node cs:name=to,anchor=west) +(.3,-.3) coordinate (too) {};
  \path (node cs:name=io,anchor=west) +(.3,.3) coordinate (ioi) {};
  \draw[->,double] (too) -- (ioi);
  \path (node cs:name=io,anchor=west) +(.6,-.3) coordinate (ioo) {};
  \path (node cs:name=oq,anchor=west) +(-.2-2*.4,0) coordinate (oqi) {};
  \draw[->,double] (ioo) -- (oqi);
  \path (node cs:name=oq,anchor=west) +(-.2,0) coordinate (oqo) {};
  \path (node cs:name=odd,anchor=west) +(.3,.3) coordinate (oddi) {};
  \draw[->,double] (oqo) -- (oddi);

  \path (node cs:name=iso,anchor=south) coordinate (tro) {};
  \path (node cs:name=to,anchor=west) coordinate (tri) {};
  \draw[->,double] (tro) -- (tri) node [midway,below] {Ack};

  \draw[red] (node cs:name=ti,anchor=west) node [left] {socket lock};
  \draw[red] (node cs:name=to,anchor=east) node [right] {socket lock};
  \draw[red] (node cs:name=ii,anchor=west) node [left] {shared net lock};
\end{tikzpicture}
\end{frame}

\section{Performance}

%\subsection{Variants for TCP Input}
%\begin{frame}{Variants for TCP Input}
%\begin{tikzpicture}
%  \path (0,0) node [anchor=south west] {
%    \begin{adjustbox}{width=\textwidth-0\baselineskip}
%      \input{gnuplot/2025-01-26T17-08-00Z-tcp-0,1,2,3.tex}
%    \end{adjustbox}
%  };
%  \path[red,font=\small]
%    (3.8,1.5) node [anchor=south] {exclusive} node [anchor=center] {net lock}
%    ++(2.4,0) node [anchor=south] {goal}
%    ++(2.4,0) node [anchor=south] {cost of} node [anchor=center] {socket lock}
%    ++(2.4,0) node [anchor=south] {parallel} node [anchor=center] {TCP input}
%  ;
%\end{tikzpicture}
%\end{frame}

%\subsection{Exclusive TCP Receive Single Stream}
%\begin{frame}{Exclusive TCP Receive Single Stream}
%    \includegraphics[width=\textwidth]{kstack/sys-tcp-input-solock-rev-single.pdf}
%\end{frame}

%\subsection{Parallel TCP Receive Single Stream}
%\begin{frame}{Parallel TCP Receive Single Stream}
%\begin{tikzpicture}
%  \path (0,0) node [anchor=south west] {
%    \begin{adjustbox}{width=\textwidth-0\baselineskip}
%      \includegraphics[width=\textwidth]{kstack/sys-tcp-mpinput-rev-single.pdf}
%    \end{adjustbox}
%  };
%  \path[ellipse,black,thick]
%    (1.6,2.15) node [draw,minimum width=.8cm,minimum height=.2cm] {}
%    (11.25,3.05) node [draw,minimum width=.5cm,minimum height=.2cm] {}
%  ;
%\end{tikzpicture}
%\end{frame}

\subsection{Parallel TCP Input, Socket Lock per Thread}
\begin{frame}{Parallel TCP Input, Socket Lock per Thread}
\begin{tikzpicture}
  \draw (0,0)
    node (idd) [right] {device driver} ++(.1,.6)
    rectangle ++(.4,.4) rectangle ++(.4,-.4)
    rectangle ++(.4,.4) rectangle ++(.4,-.4) ++(0,.2)
    node (iq) [right] {input queue} ++(-.5,.8)
    node (ii) [right] {ip\_input()} ++(0,1.8)
    node (ti) [right] {tcp\_input()} ++(.1,.8)
    node (rb) [left] {receive buffer} ++(0,-.2)
    rectangle ++(.4,.4) rectangle ++(.4,-.4)
    rectangle ++(.4,.4) rectangle ++(.4,-.4) ++(-.5,1.0)
    node (iso) [right] {socket} ++(2.5,0)

    node (oso) [right] {socket} ++(.1,-.6)
    rectangle ++(.4,-.4) rectangle ++(.4,.4)
    rectangle ++(.4,-.4) rectangle ++(.4,.4) ++(0,-.2)
    node (sb) [right] {send buffer} ++(-.5,-0.8)
    node (to) [right] {tcp\_output()} ++(0,-1.8)
    node (io) [right] {ip\_output()} ++(0,-.6)
    rectangle ++(.4,-.4) rectangle ++(.4,.4)
    rectangle ++(.4,-.4) rectangle ++(.4,.4) ++(0,-.2)
    node (oq) [right] {output queue} ++(-.5,-.8)
    node (odd) [right] {device driver}
    ;
  \path (node cs:name=idd,anchor=west) +(.3+1*.4,.3) coordinate (iddo) {};
  \path (node cs:name=iq,anchor=west) +(-.2-2*.4,0) coordinate (iqi) {};
  \draw[->,double] (iddo) -- (iqi);
  \path (node cs:name=iq,anchor=west) +(-.2,0) coordinate (iqo) {};
  \path (node cs:name=ii,anchor=west) +(.3,-.3) coordinate (iii) {};
  \draw[->,double] (iqo) -- (iii);
  \path (node cs:name=ii,anchor=west) +(.3,.3) coordinate (iio) {};
  \path (node cs:name=ti,anchor=west) +(.3,-.3) coordinate (tii) {};
  \draw[->,double] (iio) -- (tii) node (tt) [midway] {};
  \draw[->,double] (node cs:name=tt) arc [start angle=360,end angle=0,radius=-.4cm];
  \path (node cs:name=ti,anchor=west) +(.3+1*.4,.3) coordinate (iti) {};
  \path (node cs:name=rb,anchor=east) +(.2+1*.4,0) coordinate (rbi) {};
  \draw[->,double] (iti) -- (rbi);
  \path (node cs:name=rb,anchor=east) +(.2+3*.4,0) coordinate (rbo) {};
  \path (node cs:name=iso,anchor=west) +(.3,-.3) coordinate (isoi) {};
  \draw[->,double] (rbo) -- (isoi);

  \path (node cs:name=oso,anchor=west) +(.3+1*.4,-.3) coordinate (osoo) {};
  \path (node cs:name=sb,anchor=west) +(-.2-2*.4,0) coordinate (sbi) {};
  \draw[->,double] (osoo) -- (sbi);
  \path (node cs:name=sb,anchor=west) +(-.2,0) coordinate (sbo) {};
  \path (node cs:name=to,anchor=west) +(.3,.3) coordinate (toi) {};
  \draw[->,double] (sbo) -- (toi);
  \path (node cs:name=to,anchor=west) +(.3,-.3) coordinate (too) {};
  \path (node cs:name=io,anchor=west) +(.3,.3) coordinate (ioi) {};
  \draw[->,double] (too) -- (ioi);
  \path (node cs:name=io,anchor=west) +(.6,-.3) coordinate (ioo) {};
  \path (node cs:name=oq,anchor=west) +(-.2-2*.4,0) coordinate (oqi) {};
  \draw[->,double] (ioo) -- (oqi);
  \path (node cs:name=oq,anchor=west) +(-.2,0) coordinate (oqo) {};
  \path (node cs:name=odd,anchor=west) +(.3,.3) coordinate (oddi) {};
  \draw[->,double] (oqo) -- (oddi);

  \path (node cs:name=iso,anchor=south) coordinate (tro) {};
  \path (node cs:name=to,anchor=west) coordinate (tri) {};
  \draw[->,double] (tro) -- (tri) node [midway,below] {Ack};


  \draw[red] (node cs:name=ti,anchor=west) node [left] {thread socket lock};
  \draw[red] (node cs:name=to,anchor=east) node [right] {socket lock};
  \draw[red] (node cs:name=ii,anchor=west) node [left] {shared net lock};
\end{tikzpicture}
\end{frame}

%\subsection{TCP Receive Parallel Stream, Socket Lock per Thread}
%\begin{frame}{TCP Receive Parallel Stream, Socket Lock per Thread}
%    \includegraphics[width=\textwidth]{kstack/sys-tcp-input-parallel-rev-parallel.pdf}
%\end{frame}

%\subsection{Mission Accomplished}
%\begin{frame}{Mission Accomplished}
%\begin{tikzpicture}
%  \path (0,0) node [anchor=south west] {
%    \begin{adjustbox}{width=\textwidth-0\baselineskip}
%      \input{gnuplot/2025-01-26T17-08-00Z-tcp-0,1,2,3.tex}
%    \end{adjustbox}
%  };
%  \path[red,font=\small]
%    (3.8,1.5) node [anchor=south] {exclusive} node [anchor=center] {net lock}
%    ++(2.4,0) node [anchor=south] {per thread} node [anchor=center] {socket lock}
%    ++(2.4,0) node [anchor=south] {cost of} node [anchor=center] {socket lock}
%    ++(2.4,0) node [anchor=south] {parallel} node [anchor=center] {TCP input}
%  ;
%\end{tikzpicture}
%\end{frame}

\end{document}
